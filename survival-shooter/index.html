<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Brick Breaker (safe build)</title>
  <link rel="stylesheet" href="../shared/style.css?v=3">
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import {attachUI} from "../shared/ui.js?v=3";
    import {fitHiDPI, clamp, shaker, rint} from "../shared/utils.js?v=3";
    import {SFX} from "../shared/sfx.js?v=3";
    import {burst, updateAndDraw as drawParticles} from "../shared/particles.js?v=3";

    console.log("RUN: brick-breaker safe build");

    const ui = attachUI(document.getElementById("root"), {
      title:"Brick Breaker",
      instructions:"마우스/터치로 패들을 움직이세요. F키 또는 클릭으로 유도 미사일 발사! (P=일시정지, R=재시작)"
    });
    const canvas = ui.canvas;
    const g = fitHiDPI(canvas, 1600, 900);
    const ctx = g.ctx;

    // ---- Speed Panel (no template string) ----
    const SPEED_MAP = {1:0.65, 2:0.85, 3:1.00, 4:1.20, 5:1.45};
    let speedLevel = +(localStorage.getItem("gg-speed") || 3);
    let speedScale = SPEED_MAP[speedLevel] || 1;

    const panel = document.createElement("div");
    panel.style.position = "absolute";
    panel.style.left = "12px";
    panel.style.bottom = "12px";
    panel.style.display = "flex";
    panel.style.gap = "8px";
    panel.style.alignItems = "center";
    panel.style.background = "rgba(0,0,0,.35)";
    panel.style.border = "1px solid #2a2f5e";
    panel.style.borderRadius = "999px";
    panel.style.padding = "6px 10px";
    panel.style.backdropFilter = "blur(6px)";
    const label = document.createElement("span");
    label.className = "small";
    label.style.color = "#97a0d9";
    label.textContent = "Speed";
    const select = document.createElement("select");
    select.id = "gg-speed";
    select.className = "ui";
    select.style.padding = "4px 8px";
    select.style.background = "#11162f";
    select.style.border = "1px solid #2a2f5e";
    select.style.color = "#e9ecff";
    select.style.borderRadius = "8px";
    for (let i=1;i<=5;i++){ const o=document.createElement("option"); o.value=String(i); o.textContent=String(i); select.appendChild(o); }
    select.value = String(speedLevel);
    select.onchange = (e)=>{ speedLevel = +select.value; speedScale = SPEED_MAP[speedLevel]||1; localStorage.setItem("gg-speed", String(speedLevel)); };
    panel.appendChild(label); panel.appendChild(select);
    ui.canvas.parentElement.appendChild(panel);
    // ------------------------------------------

    let running=false, paused=false, score=0, lives=3;
    const particles=[];
    const paddle={x:g.w/2, y:g.h-40, w:200, h:18, target:g.w/2};
    const ball={x:g.w/2, y:g.h-80, vx:4, vy:-6, r:10, speed:8};
    let bricks=[], cols=12, rows=7, margin=12;

    const missiles=[];
    const MISSILE = { speed: 12, turn: 0.14, r: 8, life: 4000 };

    function resetLevel(){
      bricks=[];
      const bw=(g.w - margin*2 - (cols-1)*8)/cols, bh=28;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          bricks.push({x:margin+c*(bw+8), y:100+r*(bh+6), w:bw, h:bh, hp:1+rint(0,1)});
        }
      }
    }
    function resetBall(){
      ball.x=g.w/2; ball.y=g.h-80; ball.vx=(Math.random()>.5?1:-1)*4; ball.vy=-6; ball.speed=8;
    }
    function restart(){
      score=0; ui.setScore(0,"brick-breaker");
      lives=3; rows=7; bricks.length=0; missiles.length=0; particles.length=0;
      resetLevel(); resetBall();
      running=true; paused=false;
    }
    ui.wireHandlers(()=>{ if(!running) restart(); }, ()=>{ paused=!paused; }, ()=>restart());

    canvas.addEventListener("pointermove", e=>{
      const r = canvas.getBoundingClientRect();
      const px = (e.clientX - r.left)/r.width * g.w;
      paddle.target = Math.max(paddle.w/2, Math.min(g.w - paddle.w/2, px));
    });
    canvas.addEventListener("pointerdown", ()=>fireMissile());
    window.addEventListener("keydown", (e)=>{ if(e.code==="KeyF") fireMissile(); });

    const hitRect=(x,y,b)=> x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h;
    function nearestBrick(fromX, fromY){
      let best=null, bestD=1e12;
      for(const b of bricks){
        const cx = b.x + b.w/2, cy = b.y + b.h/2;
        const d = (cx-fromX)*(cx-fromX) + (cy-fromY)*(cy-fromY);
        if(d<bestD){bestD=d; best={b, cx, cy};}
      }
      return best;
    }
    function fireMissile(){
      if(!running || paused) return;
      const sx = paddle.x, sy = paddle.y - 20;
      const t = nearestBrick(sx, sy);
      const ang = t ? Math.atan2(t.cy - sy, t.cx - sx) : -Math.PI/2;
      missiles.push({ x:sx, y:sy, vx:Math.cos(ang)*MISSILE.speed, vy:Math.sin(ang)*MISSILE.speed, life:MISSILE.life, r:MISSILE.r });
      SFX.power(); burst(particles, sx, sy, "#7cf1d1", 10);
    }

    let last=performance.now();
    function frame(t){
      requestAnimationFrame(frame);
      const dt=Math.min(32,t-last); last=t;
      const dtScaled = dt * speedScale;

      ctx.clearRect(0,0,g.w,g.h);
      const grd=ctx.createLinearGradient(0,0,0,g.h); grd.addColorStop(0,"#0e1334"); grd.addColorStop(1,"#090b1f");
      ctx.fillStyle=grd; ctx.fillRect(0,0,g.w,g.h);

      if(!running){ drawDim("클릭 또는 Space로 시작"); return; }
      if(paused){ drawDim("일시정지 (P)"); return; }

      paddle.x += (paddle.target - paddle.x) * 0.25 * (dtScaled/16);
      ball.x += ball.vx*(dtScaled/16)*ball.speed;
      ball.y += ball.vy*(dtScaled/16)*ball.speed;

      if(ball.x<ball.r || ball.x>g.w-ball.r){ ball.vx*=-1; SFX.click(); }
      if(ball.y<ball.r){ ball.vy*=-1; SFX.click(); }
      if(ball.y>g.h+40){
        lives--; shaker.add(10,200); SFX.boom(); resetBall();
        if(lives<0){ running=false; showOver(); return; }
      }

      const paddleBox={x:paddle.x-paddle.w/2,y:paddle.y-paddle.h/2,w:paddle.w,h:paddle.h};
      if(hitRect(ball.x,ball.y,paddleBox) && ball.vy>0){
        const t=(ball.x - paddle.x)/(paddle.w/2);
        ball.vx = t*6;
        ball.vy = -Math.sqrt(Math.max(4,36 - ball.vx*ball.vx));
        SFX.hit(); burst(particles, ball.x, paddle.y-10, "#80ffea", 10);
      }

      for(let i=bricks.length-1;i>=0;i--){
        const b=bricks[i];
        if(hitRect(ball.x,ball.y,b)){
          const cx = Math.max(b.x, Math.min(b.x+b.w, ball.x));
          const cy = Math.max(b.y, Math.min(b.y+b.h, ball.y));
          if(Math.abs(ball.x - cx) > Math.abs(ball.y - cy)) ball.vx *= -1; else ball.vy *= -1;
          b.hp--;
          if(b.hp<=0){
            bricks.splice(i,1);
            score+=10; ui.setScore(score,"brick-breaker");
            SFX.score(); burst(particles, ball.x, ball.y, "#ffd166", 12);
          } else {
            SFX.hit();
          }
          shaker.add(4,120);
          break;
        }
      }

      ball.speed = 8 + (1 - bricks.length/(cols*rows)) * 4;

      for(let i=missiles.length-1;i>=0;i--){
        const m = missiles[i];
        m.life -= dtScaled;
        if(m.life<=0){ missiles.splice(i,1); continue; }
        const tObj = nearestBrick(m.x, m.y);
        if(tObj){
          const desired = Math.atan2(tObj.cy - m.y, tObj.cx - m.x);
          const cur = Math.atan2(m.vy, m.vx);
          let diff = desired - cur;
          while(diff > Math.PI) diff -= Math.PI*2;
          while(diff < -Math.PI) diff += Math.PI*2;
          const turn = Math.max(-MISSILE.turn, Math.min(MISSILE.turn, diff));
          const newA = cur + turn;
          m.vx = Math.cos(newA)*MISSILE.speed;
          m.vy = Math.sin(newA)*MISSILE.speed;
        }
        m.x += m.vx*(dtScaled/16);
        m.y += m.vy*(dtScaled/16);

        if(m.x<-50 || m.x>g.w+50 || m.y<-80){ missiles.splice(i,1); continue; }
        for(let j=bricks.length-1;j>=0;j--){
          const b=bricks[j];
          if(m.x> b.x && m.x < b.x+b.w && m.y> b.y && m.y < b.y+b.h){
            bricks.splice(j,1);
            score += 25; ui.setScore(score,"brick-breaker");
            SFX.boom(); shaker.add(10,200);
            burst(particles, m.x, m.y, "#ffd166", 24);
            missiles.splice(i,1);
            break;
          }
        }
      }

      ctx.save(); shaker.apply(ctx);
      ctx.fillStyle="#7cf1d1";
      ctx.fillRect(paddle.x-paddle.w/2, paddle.y-paddle.h/2, paddle.w, paddle.h);
      ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
      for(const b of bricks){
        ctx.fillStyle = b.hp>1 ? "#a2b1ff" : "#d0d7ff";
        ctx.fillRect(b.x, b.y, b.w, b.h);
      }
      for(const m of missiles){
        ctx.fillStyle="#7cf1d1";
        ctx.beginPath(); ctx.arc(m.x, m.y, m.r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle="rgba(124,241,209,.55)"; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(m.x - m.vx*0.6, m.y - m.vy*0.6); ctx.lineTo(m.x, m.y); ctx.stroke();
      }
      drawParticles(ctx, particles, dtScaled);
      ctx.restore();

      ctx.fillStyle="#97a0d9"; ctx.font="18px system-ui";
      ctx.fillText("Lives: " + Math.max(0,lives), g.w-110, 30);

      if(bricks.length===0){ rows=Math.min(10, rows+1); resetLevel(); resetBall(); SFX.power(); }
    }
    requestAnimationFrame(frame);

    function drawDim(text){
      ctx.fillStyle="rgba(0,0,0,.25)"; ctx.fillRect(0,0,g.w,g.h);
      ctx.fillStyle="#e9ecff"; ctx.font="bold 42px system-ui"; ctx.textAlign="center";
      ctx.fillText(text, g.w/2, g.h/2);
    }
    function showOver(){
      ui.modal.style.display="grid";
      ui.modal.querySelector(".title").textContent="Game Over";
      ui.modal.querySelector(".subtitle").textContent="점수 " + score;
    }
    resetLevel();
  </script>
</body>
</html>
